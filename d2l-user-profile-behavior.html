<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-organization-hm-behavior/d2l-organization-hm-behavior.html">
<link rel="import" href="../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">

<script src="https://s.brightspace.com/lib/d2lfetch/1.0.0/d2lfetch.js"></script>
<script src="https://s.brightspace.com/lib/siren-parser/6.0.0/siren-parser.js"></script>
<script>
	'use strict';

	/* @polymerBehavior userProfileBehaviorImpl */
	var userProfileBehaviorImpl = {
		properties: {
			token: String,
			userUrl: String,
			_doneRequests: {
				type: Boolean,
				value: false
			},
			_backgroundColor: {
				type: String,
				observer: '_checkDoneRequests',
				value: ''
			},
			_backgroundUrl: {
				type: String,
				observer: '_checkDoneRequests',
				value: ''
			},
			_name: {
				type: String,
				observer: '_checkDoneRequests',
				value: ''
			}
		},
		_backgroundColor: '',
		_backgroundUrl: '',
		_enrollmentsUrl: '',
		_headers: '',
		_iconUrl: '',
		_institutionUrl: '',
		_name: '',
		_organizationImageUrl: '',
		_organizationsUrl: '',
		_previousUserCall: null,
		_themeUrl: '',
		_checkDoneRequests: function() {
			var backgroundExists = !!(this._backgroundUrl || this._backgroundColor);
			var backgroundNeeded = (this.options || {}).background;
			var doneRequests = (!backgroundNeeded || backgroundExists) && !!this._name;

			if (doneRequests) {
				if (this._backgroundUrl) {
					// preload the image a bit so after the fade-in it's hopefully loaded
					var self = this;
					var setLoaded = function() {
						self._doneRequests = true;
					};
					var imagePreloader = document.createElement('img');
					imagePreloader.addEventListener('load', setLoaded);
					imagePreloader.addEventListener('error', setLoaded);
					imagePreloader.setAttribute('src', self._backgroundUrl);
				}

				this._doneRequests = true;
			}
		},
		generateUserRequest: function(userUrl, token, options) {
			this._previousUserCall = this._previousUserCall || {};
			this.userUrl = userUrl || this.userUrl;
			this.token = token || this.token;
			this.options = options || {};
			this._doneRequests = false;

			if (
				this.userUrl &&
				this.token &&
				this.userUrl !== this._previousUserCall.userUrl &&
				this.token !== this._previousUserCall.token
			) {
				this._previousUserCall = { userUrl: this.userUrl, token: this.token };
				this._headers = {
					Authorization: 'Bearer ' + this.token,
					Accept: 'application/vnd.siren+json'
				};

				var that = this;

				return this._fetchEntity(this.userUrl, this.headers)
					.then(function(userResponse) {
						that._setDataFromUserResponse(userResponse);

						if (that.options.background) {
							that._enrollmentsUrl = (userResponse.getLinkByRel(that.HypermediaRels.myEnrollments) || {}).href;
							that._folioUrl = (userResponse.getLinkByRel(that.HypermediaRels.Folio.folio) || {}).href;

							if (that._folioUrl) {
								return that._fetchEntity(that._folioUrl, that._headers)
									.then(function(folioResponse) {

										if (folioResponse) {
											var tiles = (folioResponse.getSubEntitiesByRel(that.HypermediaRels.Folio.evidence));
											for (var i = 0; i < tiles.length; i++) {
												var content = tiles[i].getSubEntityByRel(that.HypermediaRels.Folio.contentItem);
												var type = content.properties.type;
												if (type === 'Jpg' && type !== 'Png') {
													that._backgroundUrl = content.properties.url;
													return;
												}
											}
										} else {
											// Since the folio request failed, try to get the enrollment image
											return that._makeEnrollmentsRequest();
										}
									});
							} else {
								return that._makeEnrollmentsRequest();
							}
						}
					});
			}
		},
		_makeRootRequest: function() {
			if (this._rootUrl) {
				var that = this;

				return this._fetchEntity(this._rootUrl, this._headers)
					.then(function(rootResponse) {
						that._institutionUrl = (rootResponse.getLinkByRel(that.HypermediaRels.organization) || {}).href;

						if (that._institutionUrl) {
							return that._fetchEntity(that._institutionUrl, that._headers)
								.then(function(institutionResponse) {
									if (institutionResponse) {
										that._themeUrl = (institutionResponse.getLinkByRel(that.HypermediaRels.theme) || {}).href;

										if (that._themeUrl) {
											return that._fetchEntity(that._themeUrl, that._headers)
												.then(function(theme) {
													if (theme && theme.properties) {
														that._backgroundColor = theme.properties.BackgroundColor;
													} else {
														that._backgroundColor = 'initial';
													}
												});
										}
									}

									that._backgroundColor = 'initial';
								});
						} else {
							that._backgroundColor = 'initial';
						}
					});
			}
		},

		_makeEnrollmentsRequest: function() {
			// currently only called if we need an image and we can't get one from folio
			if (this._enrollmentsUrl) {
				this._enrollmentsUrl += '?pageSize=2&orgUnitTypeId=3&embedDepth=1';

				var that = this;

				return this._fetchEntity(this._enrollmentsUrl, this._headers)
					.then(function(enrollmentsResponse) {
						var enrollmentEntities = enrollmentsResponse.getSubEntitiesByRel(that.HypermediaRels.userEnrollment);

						if (enrollmentEntities.length === 1) {
							that._organizationsUrl = enrollmentEntities[0].getLinkByRel(that.HypermediaRels.organization).href;

							return that._fetchEntity(that._organizationsUrl, that._headers)
								.then(function(organizationsResponse) {
									var imageLink = organizationsResponse && organizationsResponse.getSubEntityByClass( that.HypermediaClasses.courseImage.courseImage);

									if (imageLink) {
										that._fetchEntity(imageLink.href, that._headers)
											.then(function(organizationImageResponse) {
												if (organizationImageResponse) {
													var backgroundImages = that._getImageLinks(organizationImageResponse, that.HypermediaClasses.courseImage.wide);
													that._backgroundUrl = backgroundImages.highMin || backgroundImages.lowMax;
												} else {
													// image request failed, get the background color
													return that._makeRootRequest();
												}
											});
									} else {
										// No organization image, get the background color
										return that._makeRootRequest();
									}
								});
						}

						// More than 1 enrollment, get the background color
						return that._makeRootRequest();
					});
			} else {
				// No enrollments url, get the background color
				return this._makeRootRequest();
			}
		},

		_setDataFromUserResponse: function(userResponse) {
			this._name = (userResponse.getSubEntityByRel(this.HypermediaRels.displayName) || { properties: {} }).properties.name;
			var profile = userResponse.getSubEntityByRel(this.HypermediaRels.userProfile);

			if (profile) {
				var image = profile.getSubEntityByRel(this.HypermediaRels.profileImage);
				if (image.class.indexOf('default-image') > -1) {
					this._iconUrl = null;
				} else {
					this._iconUrl = (image.getLinkByRel(this.HypermediaRels.thumbnailAlternative) || {}).href;
				}
			}

			this._rootUrl = (userResponse.getLinkByRel(this.HypermediaRels.root) || {}).href;
		},

		_fetchEntity: function(url, headers) {
			var request = new Request(url, {
				headers: headers
			});

			return window.d2lfetch
				.fetch(request)
				.then(function(response) {
					if (response.ok) {
						return response.json();
					}
					return Promise.reject(response.status);
				})
				.then(window.D2L.Hypermedia.Siren.Parse);
		}
	};

	window.D2L = window.D2L || {};
	/*
	* Behavior for user profile-related elements such as user-tile and user-switcher.
	* @polymerBehavior window.D2L.UserProfileBehavior
	*/
	window.D2L.UserProfileBehavior = [
		window.D2L.Hypermedia.OrganizationHMBehavior,
		window.D2L.Hypermedia.HMConstantsBehavior,
		userProfileBehaviorImpl
	];
</script>
